### Create a constraint template to make certain labels mandatory on pods

```
vim labels-needed.yaml
```

```
apiVersion: templates.gatekeeper.sh/v1beta1
kind: ConstraintTemplate
metadata:
  name: k8srequiredlabels
spec:
  crd:
    spec:
      names:
        kind: K8sRequiredLabels
      validation:
        # Schema for the "parameters" field
        openAPIV3Schema:
          properties:
            labels:
              type: array
              items: string
  targets:
    - target: admission.k8s.gatekeeper.sh
      rego: |
        package k8srequiredlabels

        violation[{"msg": msg, "details": {"missing_labels": missing}}] {
          provided := {label | input.review.object.metadata.labels[label]}
          required := {label | label := input.parameters.labels[_]}
          missing := required - provided
          count(missing) > 0
          msg := sprintf("you must provide labels: %v", [missing])
        }
```

```
kubectl apply -f labels-needed.yaml
kubectl get constrainttemplate
```


### Now, create a template that uses that constraint-template

```
vim pod-need-labels.yaml
```

```
apiVersion: constraints.gatekeeper.sh/v1beta1
kind: K8srequiredlabels
metadata:
  name: ns-must-have-ns
spec:
  match:
    kinds:
      - apiGroups: [""]
        kinds: ["Pod"]
  parameters:
    labels: ["client"]
```

```
kubectl apply -f pod-need-labels.yaml
kubectl get constraint
```

### CREATE a pod without label defined, it will fail

```
vim testpod.yaml
```

```
apiVersion: v1
kind: Pod
metadata:
  name: extra
  namespace: dev
spec:
  containers:
  - name: web
    image: lovelearnlinux/webserver:v1
    ports:
    - containerPort: 80
```

```
kubectl apply -f testpod.yaml
```

***<check the ERROR>***


### APPLY labels on pods, it will pass now

```
vim testpod.yaml
```

```
apiVersion: v1
kind: Pod
metadata:
  name: extra
  labels:
    client: networknuts
spec:
  containers:
  - name: web
    image: lovelearnlinux/webserver:v1
    ports:
    - containerPort: 80
```

```
kubectl apply -f testpod.yaml
```




# üîê Kubernetes Secrets Encryption at Rest

### 1. Generate an Encryption Key

```bash
head -c 32 /dev/urandom | base64
```

Copy this generated key for use in the configuration file.

---

### 2. Create an Encryption Config File

```bash
vim /etc/kubernetes/enc/enc.yaml
```

```yaml
apiVersion: apiserver.config.k8s.io/v1
kind: EncryptionConfiguration
resources:
  - resources:
      - secrets
    providers:
      - aescbc:
          keys:
            - name: keyone
              # Paste the key generated in Step 1 here
              secret: <base64-encoded-key>
      - identity: {}   # fallback allows reading unencrypted secrets
```

---

### 3. Configure the API Server to Use Encryption

‚ö†Ô∏è **Important:** Take a backup of the kube-apiserver manifest before editing.

```bash
cp /etc/kubernetes/manifests/kube-apiserver.yaml \
   /etc/kubernetes/manifests/kube-apiserver.yaml.bak
```

Edit the kube-apiserver manifest:

```bash
vim /etc/kubernetes/manifests/kube-apiserver.yaml
```

#### Add these flags under `command:`

```yaml
- --encryption-provider-config=/etc/kubernetes/enc/enc.yaml
- --encryption-provider-config-automatic-reload=true
```

#### Add under `volumeMounts:`

```yaml
- name: enc
  mountPath: /etc/kubernetes/enc
  readOnly: true
```

#### Add under `volumes:`

```yaml
- name: enc
  hostPath:
    path: /etc/kubernetes/enc
    type: DirectoryOrCreate
```

Save and exit.
Kubelet will automatically restart the API server pod with the new settings.

---

### 4. Test the Encryption

Create a new secret:

```bash
kubectl create secret generic second --from-literal=password=redhat
```

---

### 5. Verify Secrets Are Encrypted in etcd

#### Method 1: Inspect etcd Database Files

```bash
cd /var/lib/etcd/member/snap
vim db
```

Search for secrets:

```
/secret
```

‚û°Ô∏è The secret should no longer appear in plain text.

---

#### Method 2: Query etcd Directly

```bash
kubectl -n kube-system exec -it etcd-manager -- sh -c \
"ETCDCTL_API=3 \
 ETCDCTL_CACERT=/etc/kubernetes/pki/etcd/ca.crt \
 ETCDCTL_CERT=/etc/kubernetes/pki/etcd/server.crt \
 ETCDCTL_KEY=/etc/kubernetes/pki/etcd/server.key \
 etcdctl --endpoints=https://127.0.0.1:2379 get /registry/secrets/default/second"
```

‚û°Ô∏è You should see the value stored in **encrypted form**, not plaintext.

---

‚úÖ Now your Kubernetes cluster encrypts secrets at rest in etcd.

---


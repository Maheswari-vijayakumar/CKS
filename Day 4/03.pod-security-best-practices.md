# 🔐 Pod-Level Security in Kubernetes

A **Security Context** at the Pod level allows defining security settings that apply to all containers within the pod.  
This helps enforce consistent access control, privilege restrictions, and file system rules across containers.

---

## ✅ 1. Secure Pod with Non-Root User

By default, many container images run as the `root` user. It's a security risk in multi-tenant clusters.

We use:

- `runAsNonRoot: true`: ensures pod fails if container runs as UID 0
- `runAsUser`, `runAsGroup`: assigns non-root UID/GID
- `fsGroup`: defines file system group ownership

---

### Step 1: Create a YAML without `runAsUser`

```bash
vim secure-non-root-pod.yaml
````

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: non-root-user-pod-demo
spec:
  securityContext:
    runAsNonRoot: true
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: non-root-user-demo
    image: docker.io/demisto/iputils:1.0.0.62867
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
```

```bash
kubectl apply -f secure-non-root-pod.yaml
kubectl get pods
kubectl get pods/runasnonroot-pod-demo -ojson | jq .status.containerStatuses
```

> ❌ **Expected Failure**: Since the container runs as `root`, but `runAsNonRoot` is true — it fails to start.

---

### Step 2: Add UID/GID

Update YAML to include `runAsUser`, `runAsGroup`, and `fsGroup`.

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: non-root-user-pod-demo
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: non-root-user-demo
    image: docker.io/demisto/iputils:1.0.0.62867
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: false
      capabilities:
        drop:
          - ALL
```

```bash
kubectl apply -f secure-user-group-pod.yaml
kubectl get pods
```

#### Inside the pod:

```bash
kubectl exec -it non-root-user-pod-demo -- sh
id
touch /alok
touch /data/demo/aa
ping google.com
```

---

## ✅ 2. Pod with Limited Linux Capabilities

You can allow **specific Linux capabilities** like `NET_RAW` for pinging, while keeping others dropped.

```bash
vim specific-power.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: capability-pod-demo
spec:
  securityContext:
    runAsNonRoot: true
    runAsUser: 1000
    runAsGroup: 3000
    fsGroup: 2000
  volumes:
  - name: demo-volume
    emptyDir: {}
  containers:
  - name: capability-demo
    image: demisto/iputils:1.0.0.62867
    command: [ "tail", "-f", "/dev/null" ]
    volumeMounts:
    - name: demo-volume
      mountPath: /data/demo
    securityContext:
      privileged: false
      allowPrivilegeEscalation: true
      capabilities:
        drop:
          - ALL
        add:
         - NET_RAW
```

```bash
kubectl apply -f specific-power.yaml
kubectl get pods
```

#### Inside the pod:

```bash
kubectl exec -it capability-pod-demo -- sh
ping google.com
```

---

## ✅ 3. Pod with Read-Only Root Filesystem

This restricts write access to the root filesystem, reducing the risk of tampering or persistence.

```bash
vim readonly-pod.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: read-only-root-fs-pod-demo
spec:
  containers:
  - name: read-only-root-fs-demo
    image: docker.io/redhat/ubi8
    command: [ "tail", "-f", "/dev/null" ]
    securityContext:
      readOnlyRootFilesystem: true
```

```bash
kubectl apply -f readonly-pod.yaml
kubectl get pods
kubectl exec -it read-only-root-fs-pod-demo -- sh
```

```bash
touch alok
# => ❌ Should fail due to read-only root FS
```

---

## 📚 Reference: Linux Capabilities

Use this to choose which capabilities are essential:

🔗 [Red Hat Linux Capabilities & seccomp Guide](https://docs.redhat.com/en/documentation/red_hat_enterprise_linux_atomic_host/7/html/container_security_guide/linux_capabilities_and_seccomp)

---

## ✅ Summary Table

| Control                    | Description                              |
| -------------------------- | ---------------------------------------- |
| `runAsNonRoot: true`       | Ensures container does not run as root   |
| `runAsUser`, `runAsGroup`  | Assign non-root user/group               |
| `capabilities`             | Drop or allow specific kernel privileges |
| `readOnlyRootFilesystem`   | Restricts root file system writes        |
| `allowPrivilegeEscalation` | Prevents use of `sudo`, `su`, etc.       |


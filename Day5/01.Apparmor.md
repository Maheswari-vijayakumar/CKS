
# üõ°Ô∏è AppArmor in Kubernetes

### üîπ What is AppArmor?

**AppArmor** (Application Armor) is a **Linux Security Module (LSM)** that enforces **Mandatory Access Control (MAC)**.
It confines applications to a set of predefined rules, restricting what they can do and which files they can access ‚Äî even if the application is compromised.

---

## Step 1: Check AppArmor Status on Node

Run the following commands on a Kubernetes node:

```bash
cat /sys/module/apparmor/parameters/enabled
systemctl status apparmor
aa-status
```

---

## Step 2: Create a Test Pod (without restrictions)

Create a Pod manifest:

```bash
vim apparmor-test-pod.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: testpod
  labels:
    app: testpod
spec:
  nodeName: manager
  containers:
    - name: boxone
      image: lovelearnlinux/webserver:v1
```

Apply and access the Pod:

```bash
kubectl apply -f apparmor-test-pod.yaml
kubectl get pods -o wide
kubectl exec -it testpod -- /bin/bash
```

Inside the Pod:

```bash
echo "File created by the pod" > /tmp/test
cat /tmp/test
```

‚û°Ô∏è File creation succeeds. Next, we‚Äôll **deny this action** using AppArmor.

---

## Step 3: Create an AppArmor Profile

Switch to root and create a profile file:

```bash
sudo -i
cd /etc/apparmor.d
vim deny-file-write
```

Profile definition:

```apparmor
#include <tunables/global>

profile deny-file-write flags=(attach_disconnected) {
  #include <abstractions/base>

  file,

  # Deny all file writes
  deny /** w,
}
```

---

## Step 4: Load & Verify the Profile

Load the profile:

```bash
apparmor_parser /etc/apparmor.d/deny-file-write
```

Check status:

```bash
aa-status
```

Optional:

```bash
apparmor_parser -C /etc/apparmor.d/deny-file-write   # load in complain mode
apparmor_parser -R /etc/apparmor.d/deny-file-write   # remove/disable profile
```

---

## Step 5: Re-Create Pod with AppArmor Profile

Delete old Pod and manifest:

```bash
kubectl delete pod testpod
rm apparmor-test-pod.yaml
```

Create new manifest:

```bash
vim apparmor-test-pod.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: testpod
  labels:
    app: testpod
spec:
  securityContext:
    appArmorProfile:
      type: Localhost
      localhostProfile: deny-file-write
  nodeName: manager
  containers:
    - name: boxone
      image: lovelearnlinux/webserver:v1
```

Apply and test:

```bash
kubectl apply -f apparmor-test-pod.yaml
kubectl get pods -o wide
kubectl exec -it testpod -- /bin/bash
```

Try creating a file:

```bash
echo "File created by the pod" > /tmp/test
```

‚û°Ô∏è File creation should now be **denied** by AppArmor.

---

‚úÖ With this setup, you‚Äôve successfully enforced **AppArmor profiles** on Kubernetes Pods to prevent unauthorized file writes.



Would you like me to also include an **AppArmor profile lifecycle cheat sheet** (load, unload, enforce, complain) for quick reference?

# Enable gVisor Runtime in Kubernetes

gVisor is a **security-focused container runtime** that adds a lightweight user-space kernel between your containers and the host.
✅ This improves **isolation** and security at the cost of some **performance** and **compatibility**.

<img width="250" height="250" alt="gVisor" src="https://github.com/user-attachments/assets/2f7334f6-9818-48e0-b133-1a5b1447d350" />

---

### STEP 1: Install gVisor on all nodes

Create install script:

```bash
vim gvisor-install.sh
```

Add the following:

```bash
#!/bin/bash

# Update & install prerequisites
sudo apt-get update && \
sudo apt-get install -y \
    apt-transport-https \
    ca-certificates \
    curl \
    gnupg

# Add gVisor repo & keys
curl -fsSL https://gvisor.dev/archive.key | \
  sudo gpg --dearmor -o /usr/share/keyrings/gvisor-archive-keyring.gpg

echo "deb [arch=$(dpkg --print-architecture) signed-by=/usr/share/keyrings/gvisor-archive-keyring.gpg] \
https://storage.googleapis.com/gvisor/releases release main" \
| sudo tee /etc/apt/sources.list.d/gvisor.list > /dev/null

# Install runsc
sudo apt-get update && sudo apt-get install -y runsc
```

Run script:

```bash
sh gvisor-install.sh
```

---

### STEP 2: Configure containerd with gVisor (`runsc`)

Update containerd config:

```bash
cat <<EOF | sudo tee /etc/containerd/config.toml
version = 2
[plugins."io.containerd.runtime.v1.linux"]
  shim_debug = true
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runc]
  runtime_type = "io.containerd.runc.v2"
[plugins."io.containerd.grpc.v1.cri".containerd.runtimes.runsc]
  runtime_type = "io.containerd.runsc.v1"
EOF
```

Restart containerd:

```bash
sudo systemctl restart containerd
```

Configure crictl:

```bash
cat <<EOF | sudo tee /etc/crictl.yaml
runtime-endpoint: unix:///run/containerd/containerd.sock
EOF

sudo systemctl restart containerd
```

---

### STEP 3: Create RuntimeClass (Manager Node)

Create a `RuntimeClass` definition:

```bash
vim runtimeclass.yaml
```

```yaml
apiVersion: node.k8s.io/v1
kind: RuntimeClass
metadata:
  name: allsecure   # The name used in Pod specs
handler: runsc      # Points to the gVisor runtime
```

Apply RuntimeClass:

```bash
kubectl apply -f runtimeclass.yaml
kubectl get RuntimeClass
```

---

### STEP 4: Deploy a Pod using gVisor RuntimeClass

Create a test pod:

```bash
vim testpod.yaml
```

```yaml
apiVersion: v1
kind: Pod
metadata:
  name: testpod
  labels:
    app: nginx
spec:
  runtimeClassName: allsecure
  containers:
    - name: boxone
      image: nginx
```

Deploy and verify:

```bash
kubectl apply -f testpod.yaml
kubectl describe pod testpod
```

➡️ You should see **Runtime Class Name: allsecure** under the pod description.


